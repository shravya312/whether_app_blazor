@using WeatherApp.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Supabase.Gotrue
@inject WeatherApiService WeatherApiService
@inject PopularCitiesApiService PopularCitiesApiService
@inject IpGeolocationService IpGeolocationService
@inject GeolocationService GeolocationService
@inject FavoriteCitiesService FavoriteCitiesService
@inject SearchedCitiesService SearchedCitiesService
@inject SupabaseService SupabaseService
@inject ThemeService ThemeService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>
<div class="weather-container">
            <div class="weather-header mb-4">
                <h3 class="mb-3">Weather Information</h3>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" @onclick="GetCurrentLocationWeather" disabled="@isLoadingLocation">
                        @if (isLoadingLocation)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="bi bi-geo-alt"></i>
                        }
                        Use My Location
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleTheme">
                        <i class="bi @(ThemeService.GetCurrentTheme() == "dark" ? "bi-sun" : "bi-moon")"></i>
                        @(ThemeService.GetCurrentTheme() == "dark" ? "Light" : "Dark") Mode
                    </button>
                </div>
            </div>
    
    <div class="search-section mb-4">
        <div class="input-group">
                    <input @bind="searchCity" @bind:event="oninput" 
                           @onkeydown="HandleKeyPress" 
                           class="form-control" 
                           placeholder="Enter city name" />
                    <button @onclick="SearchWeather" class="btn btn-primary" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <text><i class="bi bi-search"></i> Get Weather</text>
                        }
                    </button>
        </div>
    </div>

            <AuthorizeView>
                <Authorized Context="authContext1">
                    <div class="favorite-cities-section mb-4">
                        <h5>Favorite Cities</h5>
                        @if (favoriteCitiesLoading)
                        {
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm"></div>
                            </div>
                        }
                        else if (favoriteCities.Any())
                        {
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var fav in favoriteCities)
                                {
                                    <button class="btn btn-sm btn-outline-info" @onclick="() => LoadFavoriteCity(fav.City, fav.Country)">
                                        @fav.City, @fav.Country
                                        <button class="btn-close btn-close-sm ms-2" @onclick="() => RemoveFavorite(fav.Id)" @onclick:stopPropagation="true"></button>
                                    </button>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted small">No favorite cities yet. Add cities to your favorites!</p>
                        }
                    </div>
                </Authorized>
            </AuthorizeView>

            <div class="popular-cities-section mb-4">
        <label class="form-label">Quick pick a popular city</label>
        <input @bind="cityFilter" @bind:event="oninput" class="form-control mb-2" placeholder="Search within popular cities" />
        <select class="form-select city-select" size="5" @onchange="OnCitySelected">
            @foreach (var city in FilteredCities)
            {
                <option value="@city">@city</option>
            }
        </select>
    </div>

    @if (isLoading)
    {
                <div class="alert alert-info text-center">
                    <div class="spinner-border me-2"></div>
                    Loading weather data...
                </div>
    }

    @if (errorMessage != null)
    {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                </div>
    }

    @if (currentWeather != null)
    {
                <div class="weather-card current-weather">
                    <div class="weather-card-header">
            <h4>@currentWeather.City, @currentWeather.Country</h4>
                        <AuthorizeView>
                            <Authorized Context="authContext2">
                                @if (isFavorite)
                                {
                                    <button class="btn btn-sm btn-danger" @onclick="RemoveCurrentFavorite" title="Remove from favorites">
                                        <i class="bi bi-heart-fill"></i>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger" @onclick="AddCurrentFavorite" title="Add to favorites">
                                        <i class="bi bi-heart"></i>
                                    </button>
                                }
                            </Authorized>
                        </AuthorizeView>
                    </div>
                    
                    <div class="weather-main">
                        <div class="weather-icon">
                            @if (!string.IsNullOrEmpty(currentWeather.Icon))
                            {
                                <img src="@($"https://openweathermap.org/img/wn/{currentWeather.Icon}@2x.png")" alt="@currentWeather.Description" />
                            }
                        </div>
                        <div class="weather-temp">
                            <div class="temp-main">@currentWeather.Temperature.ToString("F1")°C</div>
                            <div class="temp-feels">Feels like @currentWeather.FeelsLike.ToString("F1")°C</div>
                            <div class="temp-desc">@currentWeather.Description</div>
                        </div>
                    </div>

                    <div class="weather-details-grid">
                        <div class="detail-item">
                            <i class="bi bi-droplet"></i>
                            <div>
                                <div class="detail-label">Humidity</div>
                                <div class="detail-value">@currentWeather.Humidity.ToString("F0")%</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-wind"></i>
                            <div>
                                <div class="detail-label">Wind Speed</div>
                                <div class="detail-value">@currentWeather.WindSpeed.ToString("F1") m/s</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-speedometer"></i>
                            <div>
                                <div class="detail-label">Pressure</div>
                                <div class="detail-value">@currentWeather.Pressure.ToString("F0") hPa</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-eye"></i>
                            <div>
                                <div class="detail-label">Visibility</div>
                                <div class="detail-value">@(currentWeather.Visibility > 0 ? currentWeather.Visibility.ToString("F1") + " km" : "N/A")</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-cloud"></i>
                            <div>
                                <div class="detail-label">Cloudiness</div>
                                <div class="detail-value">@currentWeather.Cloudiness.ToString("F0")%</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-clock"></i>
                            <div>
                                <div class="detail-label">Last Updated</div>
                                <div class="detail-value">@currentWeather.Timestamp.ToLocalTime().ToString("g")</div>
                            </div>
                        </div>
                    </div>
                </div>

                @if (forecastData != null && forecastData.Items.Any())
                {
                    <div class="forecast-section mt-4">
                        <h5 class="mb-3">5-Day Forecast</h5>
                        <div class="forecast-container">
                            @foreach (var item in forecastData.Items.Take(40).GroupBy(f => f.DateTime.Date).Take(5))
                            {
                                var dayForecast = item.OrderBy(f => f.DateTime).ToList();
                                var dayItem = dayForecast.First();
                                <div class="forecast-day">
                                    <div class="forecast-day-header">
                                        <strong>@dayItem.DateTime.ToString("dddd, MMM dd")</strong>
                                    </div>
                                    <div class="forecast-items">
                                        @foreach (var forecastItem in dayForecast.Take(8))
                                        {
                                            <div class="forecast-item">
                                                <div class="forecast-time">@forecastItem.DateTime.ToString("HH:mm")</div>
                                                <div class="forecast-icon">
                                                    <img src="https://openweathermap.org/img/wn/@(forecastItem.Icon).png" alt="@forecastItem.Description" />
                                                </div>
                                                <div class="forecast-temp">@forecastItem.Temperature.ToString("F0")°</div>
                                                <div class="forecast-desc">@forecastItem.Description</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </Authorized>
    <NotAuthorized>
<div class="weather-container">
            <div class="alert alert-info">
                <h5>Welcome to Weather App!</h5>
                <p>Sign in to access advanced features like favorite cities, extended forecasts, and personalized dashboard.</p>
                <a href="/auth" class="btn btn-primary">Sign In</a>
            </div>
            
            <div class="weather-header mb-4">
                <h3 class="mb-3">Weather Information</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" @onclick="GetCurrentLocationWeather" disabled="@isLoadingLocation">
                        @if (isLoadingLocation)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="bi bi-geo-alt"></i>
                        }
                        Use My Location
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleTheme">
                        <i class="bi @(ThemeService.GetCurrentTheme() == "dark" ? "bi-sun" : "bi-moon")"></i>
                        @(ThemeService.GetCurrentTheme() == "dark" ? "Light" : "Dark") Mode
                    </button>
                </div>
            </div>
    
    <div class="search-section mb-4">
        <div class="input-group">
                    <input @bind="searchCity" @bind:event="oninput" 
                           @onkeydown="HandleKeyPress" 
                           class="form-control" 
                           placeholder="Enter city name" />
                    <button @onclick="SearchWeather" class="btn btn-primary" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <text><i class="bi bi-search"></i> Get Weather</text>
                        }
                    </button>
        </div>
    </div>

            <div class="popular-cities-section mb-4">
        <label class="form-label">Quick pick a popular city</label>
        <input @bind="cityFilter" @bind:event="oninput" class="form-control mb-2" placeholder="Search within popular cities" />
        <select class="form-select city-select" size="5" @onchange="OnCitySelected">
            @foreach (var city in FilteredCities)
            {
                <option value="@city">@city</option>
            }
        </select>
    </div>

    @if (isLoading)
    {
                <div class="alert alert-info text-center">
                    <div class="spinner-border me-2"></div>
                    Loading weather data...
                </div>
    }

    @if (errorMessage != null)
    {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                </div>
    }

    @if (currentWeather != null)
    {
                <WeatherAlerts CurrentWeather="currentWeather" ForecastData="forecastData" />
                
                <div class="weather-card current-weather">
                    <div class="weather-card-header">
            <h4>@currentWeather.City, @currentWeather.Country</h4>
                    </div>
                    
                    <div class="weather-main">
                        <div class="weather-icon">
                            @if (!string.IsNullOrEmpty(currentWeather.Icon))
                            {
                                <img src="@($"https://openweathermap.org/img/wn/{currentWeather.Icon}@2x.png")" alt="@currentWeather.Description" />
                            }
                        </div>
                        <div class="weather-temp">
                            <div class="temp-main">@currentWeather.Temperature.ToString("F1")°C</div>
                            <div class="temp-feels">Feels like @currentWeather.FeelsLike.ToString("F1")°C</div>
                            <div class="temp-desc">@currentWeather.Description</div>
                        </div>
                    </div>

                    <div class="weather-details-grid">
                        <div class="detail-item">
                            <i class="bi bi-droplet"></i>
                            <div>
                                <div class="detail-label">Humidity</div>
                                <div class="detail-value">@currentWeather.Humidity.ToString("F0")%</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-wind"></i>
                            <div>
                                <div class="detail-label">Wind Speed</div>
                                <div class="detail-value">@currentWeather.WindSpeed.ToString("F1") m/s</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-speedometer"></i>
                            <div>
                                <div class="detail-label">Pressure</div>
                                <div class="detail-value">@currentWeather.Pressure.ToString("F0") hPa</div>
                            </div>
                        </div>
            </div>
        </div>
    }
</div>
    </NotAuthorized>
</AuthorizeView>

<style>
    .weather-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .weather-card {
        background: var(--card-bg, #f8f9fa);
        border-radius: 15px;
        padding: 25px;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .weather-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .weather-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .weather-main {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
    }

    .weather-icon img {
        width: 100px;
        height: 100px;
    }

    .temp-main {
        font-size: 3rem;
        font-weight: bold;
        color: var(--primary-color, #0d6efd);
    }

    .temp-feels {
        font-size: 1rem;
        color: var(--text-muted, #6c757d);
        margin-top: 5px;
    }

    .temp-desc {
        font-size: 1.2rem;
        text-transform: capitalize;
        margin-top: 10px;
    }

    .weather-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: var(--detail-bg, rgba(255,255,255,0.5));
        border-radius: 8px;
    }

    .detail-item i {
        font-size: 1.5rem;
        color: var(--primary-color, #0d6efd);
    }

    .detail-label {
        font-size: 0.85rem;
        color: var(--text-muted, #6c757d);
    }

    .detail-value {
        font-weight: 600;
        font-size: 1rem;
    }

    .forecast-section {
        margin-top: 30px;
    }

    .forecast-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .forecast-day {
        background: var(--card-bg, #f8f9fa);
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .forecast-day-header {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color, #dee2e6);
    }

    .forecast-items {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 10px 0;
    }

    .forecast-item {
        min-width: 100px;
        text-align: center;
        padding: 10px;
        background: var(--detail-bg, rgba(255,255,255,0.5));
        border-radius: 8px;
    }

    .forecast-time {
        font-size: 0.85rem;
        color: var(--text-muted, #6c757d);
        margin-bottom: 5px;
    }

    .forecast-icon img {
        width: 40px;
        height: 40px;
    }

    .forecast-temp {
        font-weight: 600;
        margin: 5px 0;
    }

    .forecast-desc {
        font-size: 0.75rem;
        color: var(--text-muted, #6c757d);
        text-transform: capitalize;
    }

    .popular-cities-section {
        background: var(--card-bg, #ffffff);
        border: 1px solid var(--border-color, #e2e6ea);
        border-radius: 8px;
        padding: 16px;
    }

    .city-select {
        height: auto;
        max-height: 200px;
    }

    .favorite-cities-section {
        background: var(--card-bg, #ffffff);
        border: 1px solid var(--border-color, #e2e6ea);
        border-radius: 8px;
        padding: 16px;
    }

    [data-theme="dark"] {
        --card-bg: #2d3748;
        --detail-bg: rgba(255,255,255,0.1);
        --text-muted: #a0aec0;
        --border-color: #4a5568;
        --primary-color: #63b3ed;
    }

    [data-theme="dark"] .weather-card,
    [data-theme="dark"] .forecast-day,
    [data-theme="dark"] .popular-cities-section,
    [data-theme="dark"] .favorite-cities-section {
        background: var(--card-bg);
        color: #e2e8f0;
    }

    .sunny {
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    }

    .cloudy {
        background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
    }

    .rainy {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stormy {
        background: linear-gradient(135deg, #434343 0%, #000000 100%);
    }

    .snowy {
        background: linear-gradient(135deg, #e0e0e0 0%, #ffffff 100%);
    }

    .foggy {
        background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
    }

    @@media (max-width: 768px) {
        .weather-main {
            flex-direction: column;
            text-align: center;
        }

        .weather-details-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .forecast-items {
            flex-wrap: wrap;
        }
    }
</style>

@code {
    private WeatherData? currentWeather;
    private ForecastData? forecastData;
    private string searchCity = "";
    private bool isLoading = false;
    private bool isLoadingLocation = false;
    private string? errorMessage;
    private string cityFilter = "";
    private readonly List<string> defaultPopularCities = new()
    {
        "New York",
        "London",
        "Tokyo",
        "Bangalore",
        "Sydney"
    };
    private List<string> popularCities = new();
    private List<FavoriteCity> favoriteCities = new();
    private bool favoriteCitiesLoading = false;
    private bool isFavorite = false;
    private string? currentUserId;

    private IEnumerable<string> FilteredCities =>
        popularCities.Where(city =>
            string.IsNullOrWhiteSpace(cityFilter) ||
            city.Contains(cityFilter, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await ThemeService.InitializeThemeAsync();
        await LoadPopularCitiesAsync();
        
        var user = SupabaseService.GetCurrentUser();
        if (user != null)
        {
            currentUserId = user.Id;
            await LoadFavoriteCitiesAsync();
        }
    }

    private async Task SearchWeather()
    {
        if (string.IsNullOrWhiteSpace(searchCity))
            return;

        isLoading = true;
        errorMessage = null;
        currentWeather = null;
        forecastData = null;
        isFavorite = false;
        
        try
        {
            currentWeather = await WeatherApiService.GetWeatherAsync(searchCity);
            if (currentWeather == null)
            {
                // Provide helpful suggestion for neighborhood/locality names
                var cityLower = searchCity.ToLower();
                if (cityLower.Contains("layout") || cityLower.Contains("nagar") || cityLower.Contains("colony") || 
                    cityLower.Contains("extension") || cityLower.Contains("road") || cityLower.Contains("street"))
                {
                    errorMessage = $"Weather data not found for '{searchCity}'. This appears to be a neighborhood name. Please try searching for the city name instead (e.g., 'Bangalore', 'Mumbai', 'Delhi').";
                }
                else
                {
                    errorMessage = $"Weather data not found for '{searchCity}'. Please check the spelling or try searching for a nearby major city.";
                }
            }
            else
            {
                errorMessage = null;
                await LoadForecastAsync();
                await LoadPopularCitiesAsync();
                
                if (!string.IsNullOrEmpty(currentWeather.MainCondition))
                {
                    await ThemeService.ApplyWeatherThemeAsync(currentWeather.MainCondition);
                }
                
                if (currentUserId != null)
                {
                    // Track searched city
                    await SearchedCitiesService.AddSearchedCityAsync(
                        currentUserId, 
                        currentWeather.City, 
                        currentWeather.Country);
                    
                    // Auto-add manually searched city to favorites and track search count
                    await FavoriteCitiesService.AddOrUpdateFavoriteAsync(
                        currentUserId, 
                        currentWeather.City, 
                        currentWeather.Country);
                    
                    isFavorite = await FavoriteCitiesService.IsFavoriteAsync(
                        currentUserId, 
                        currentWeather.City, 
                        currentWeather.Country);
                    
                    // Reload favorites to update order
                    await LoadFavoriteCitiesAsync();
                }
            }
        }
        catch (Exception ex)
        {
            var errorLower = ex.Message.ToLower();
            if (errorLower.Contains("not found") || errorLower.Contains("404"))
            {
                var cityLower = searchCity.ToLower();
                if (cityLower.Contains("layout") || cityLower.Contains("nagar") || cityLower.Contains("colony") || 
                    cityLower.Contains("extension") || cityLower.Contains("road") || cityLower.Contains("street"))
                {
                    errorMessage = $"Weather data not found for '{searchCity}'. This appears to be a neighborhood name. Please try searching for the city name instead (e.g., 'Bangalore', 'Mumbai', 'Delhi').";
                }
                else
                {
                    errorMessage = $"Weather data not found for '{searchCity}'. Please check the spelling or try searching for a nearby major city.";
                }
            }
            else
        {
            errorMessage = ex.Message;
            }
            currentWeather = null;
            forecastData = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GetCurrentLocationWeather()
    {
        isLoadingLocation = true;
        errorMessage = null;
        currentWeather = null;
        forecastData = null;
        isFavorite = false;
        
        try
        {
            Console.WriteLine("[WeatherDisplay] Starting location detection...");
            double latitude = 0;
            double longitude = 0;
            bool locationFound = false;
            string locationSource = "";
            
            // Try browser geolocation first (more accurate)
            try
            {
                Console.WriteLine("[WeatherDisplay] Attempting browser geolocation...");
                var browserLocation = await GeolocationService.GetCurrentLocationAsync();
                if (browserLocation.HasValue && browserLocation.Value.Error == null)
                {
                    latitude = browserLocation.Value.Latitude;
                    longitude = browserLocation.Value.Longitude;
                    locationFound = true;
                    locationSource = "Browser GPS";
                    Console.WriteLine($"[WeatherDisplay] ✅ Using browser geolocation: ({latitude}, {longitude})");
                }
                else if (browserLocation.HasValue && !string.IsNullOrEmpty(browserLocation.Value.Error))
                {
                    Console.WriteLine($"[WeatherDisplay] Browser geolocation denied/error: {browserLocation.Value.Error}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[WeatherDisplay] Browser geolocation failed: {ex.Message}");
            }
            
            // Fallback to IP-based geolocation if browser geolocation failed
            if (!locationFound)
            {
                try
                {
                    Console.WriteLine("[WeatherDisplay] Falling back to IP-based geolocation...");
                    var ipLocation = await IpGeolocationService.GetLocationByIpAsync();
                    if (ipLocation != null)
                    {
                        latitude = ipLocation.Value.Latitude;
                        longitude = ipLocation.Value.Longitude;
                        locationFound = true;
                        locationSource = "IP Geolocation";
                        Console.WriteLine($"[WeatherDisplay] ✅ Using IP geolocation: ({latitude}, {longitude})");
                        
                        // Check if IP geolocation coordinates need auto-correction for all major cities
                        // Define major cities with their boundaries, centers, and common wrong names
                        var cityMappings = new[]
                        {
                            new { City = "Bangalore", CenterLat = 12.9716, CenterLon = 77.5946, MinLat = 12.80, MaxLat = 13.15, MinLon = 77.35, MaxLon = 77.80, WrongNames = new[] { "mysore", "mysuru", "tumakuru", "tumkur" } },
                            new { City = "Mysore", CenterLat = 12.2958, CenterLon = 76.6394, MinLat = 12.20, MaxLat = 12.40, MinLon = 76.50, MaxLon = 76.75, WrongNames = new string[0] },
                            new { City = "Mumbai", CenterLat = 19.0760, CenterLon = 72.8777, MinLat = 18.5, MaxLat = 19.5, MinLon = 72.5, MaxLon = 73.5, WrongNames = new[] { "thane", "navi mumbai", "kalyan" } },
                            new { City = "Delhi", CenterLat = 28.6139, CenterLon = 77.2090, MinLat = 28.3, MaxLat = 29.0, MinLon = 76.8, MaxLon = 77.5, WrongNames = new[] { "gurgaon", "gurugram", "noida", "ghaziabad", "faridabad" } },
                            new { City = "Chennai", CenterLat = 13.0827, CenterLon = 80.2707, MinLat = 12.8, MaxLat = 13.3, MinLon = 80.0, MaxLon = 80.4, WrongNames = new[] { "madras" } },
                            new { City = "Hyderabad", CenterLat = 17.3850, CenterLon = 78.4867, MinLat = 17.2, MaxLat = 17.6, MinLon = 78.2, MaxLon = 78.7, WrongNames = new[] { "secunderabad" } },
                            new { City = "Kolkata", CenterLat = 22.5726, CenterLon = 88.3639, MinLat = 22.4, MaxLat = 22.7, MinLon = 88.2, MaxLon = 88.5, WrongNames = new[] { "calcutta", "howrah" } },
                            new { City = "Pune", CenterLat = 18.5204, CenterLon = 73.8567, MinLat = 18.3, MaxLat = 18.7, MinLon = 73.6, MaxLon = 74.0, WrongNames = new[] { "pimpri", "chinchwad" } },
                            new { City = "New York", CenterLat = 40.7128, CenterLon = -74.0060, MinLat = 40.4, MaxLat = 40.9, MinLon = -74.3, MaxLon = -73.7, WrongNames = new[] { "newark", "jersey city", "yonkers" } },
                            new { City = "London", CenterLat = 51.5074, CenterLon = -0.1278, MinLat = 51.3, MaxLat = 51.7, MinLon = -0.5, MaxLon = 0.3, WrongNames = new[] { "westminster", "greenwich", "camden" } },
                            new { City = "Tokyo", CenterLat = 35.6762, CenterLon = 139.6503, MinLat = 35.4, MaxLat = 35.9, MinLon = 139.4, MaxLon = 139.9, WrongNames = new[] { "shibuya", "shinjuku", "chiyoda" } },
                            new { City = "Sydney", CenterLat = -33.8688, CenterLon = 151.2093, MinLat = -34.0, MaxLat = -33.7, MinLon = 150.9, MaxLon = 151.3, WrongNames = new[] { "parramatta", "north sydney" } },
                            new { City = "Dubai", CenterLat = 25.2048, CenterLon = 55.2708, MinLat = 24.8, MaxLat = 25.4, MinLon = 55.0, MaxLon = 55.5, WrongNames = new[] { "sharjah", "ajman" } }
                        };
                        
                        // Check if coordinates are in a "wrong city" boundaries but closer to a major city
                        // Example: IP returns Mysore coordinates but user is actually in Bangalore
                        string? correctedCity = null;
                        double correctedLat = latitude;
                        double correctedLon = longitude;
                        
                        foreach (var city in cityMappings)
                        {
                            // Check if coordinates are in this city's boundaries
                            bool isInCityBoundaries = latitude >= city.MinLat && latitude <= city.MaxLat &&
                                                      longitude >= city.MinLon && longitude <= city.MaxLon;
                            
                            if (isInCityBoundaries)
                            {
                                // Coordinates are in correct city boundaries - no correction needed
                                Console.WriteLine($"[WeatherDisplay] ✅ Coordinates ({latitude}, {longitude}) are in {city.City} boundaries");
                                break;
                            }
                            
                            // Check if coordinates are in a "wrong city" that's in this city's wrong names list
                            foreach (var wrongCity in cityMappings)
                            {
                                if (wrongCity.City == city.City) continue;
                                
                                // Check if coordinates are in wrong city boundaries
                                bool isInWrongCityBoundaries = latitude >= wrongCity.MinLat && latitude <= wrongCity.MaxLat &&
                                                               longitude >= wrongCity.MinLon && longitude <= wrongCity.MaxLon;
                                
                                // Check if wrong city is in the correct city's wrong names list
                                bool isWrongCityName = city.WrongNames.Any(wrong => wrongCity.City.ToLower().Contains(wrong.ToLower()) || 
                                                                                    wrong.Contains(wrongCity.City.ToLower()));
                                
                                if (isInWrongCityBoundaries && isWrongCityName)
                                {
                                    // Calculate distances from both cities
                                    var distanceFromCorrectCity = Math.Sqrt(Math.Pow(latitude - city.CenterLat, 2) + Math.Pow(longitude - city.CenterLon, 2));
                                    var distanceFromWrongCity = Math.Sqrt(Math.Pow(latitude - wrongCity.CenterLat, 2) + Math.Pow(longitude - wrongCity.CenterLon, 2));
                                    
                                    // If coordinates are closer to correct city and within reasonable distance, auto-correct
                                    if (distanceFromCorrectCity < distanceFromWrongCity && distanceFromCorrectCity < 1.0) // Within ~111km
                                    {
                                        var distanceKm = distanceFromCorrectCity * 111;
                                        Console.WriteLine($"[WeatherDisplay] ⚠️ WARNING: IP geolocation returned {wrongCity.City} coordinates ({latitude}, {longitude})");
                                        Console.WriteLine($"[WeatherDisplay] ⚠️ But you might be in {city.City} (distance: {distanceKm:F0} km from {city.City} center)");
                                        Console.WriteLine($"[WeatherDisplay] ⚠️ IP geolocation is often inaccurate - auto-correcting to {city.City} coordinates");
                                        
                                        correctedCity = city.City;
                                        correctedLat = city.CenterLat;
                                        correctedLon = city.CenterLon;
                                        break;
                                    }
                                }
                            }
                            
                            if (correctedCity != null) break;
                        }
                        
                        // Apply correction if needed
                        if (correctedCity != null)
                        {
                            latitude = correctedLat;
                            longitude = correctedLon;
                            locationSource = $"IP Geolocation (Auto-corrected to {correctedCity})";
                            Console.WriteLine($"[WeatherDisplay] ✅ Auto-corrected to {correctedCity} coordinates: ({latitude}, {longitude})");
                            errorMessage = $"IP geolocation detected incorrect city, but auto-corrected to {correctedCity}. " +
                                         $"For more accurate results, please allow browser location access when clicking 'Use My Location'.";
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[WeatherDisplay] ❌ IP geolocation failed: {ex.Message}");
                }
            }
            
            if (!locationFound)
            {
                Console.WriteLine("[WeatherDisplay] ❌ All location methods failed");
                errorMessage = "Unable to get your location. Please allow browser location access or search for your city manually.";
                isLoadingLocation = false;
                return;
            }
            
            Console.WriteLine($"[WeatherDisplay] Location obtained via: {locationSource}");
            Console.WriteLine($"[WeatherDisplay] Final coordinates: Latitude={latitude}, Longitude={longitude}");

            currentWeather = await WeatherApiService.GetWeatherByLocationAsync(latitude, longitude);
            if (currentWeather == null)
            {
                errorMessage = "Weather data not found for your location.";
            }
            else
            {
                searchCity = currentWeather.City;
                await LoadForecastByLocationAsync(latitude, longitude);
                await LoadPopularCitiesAsync(); // Refresh popular cities after location-based search
                
                if (!string.IsNullOrEmpty(currentWeather.MainCondition))
                {
                    await ThemeService.ApplyWeatherThemeAsync(currentWeather.MainCondition);
                }
                
                if (currentUserId != null)
                {
                    // Track searched city
                    await SearchedCitiesService.AddSearchedCityAsync(
                        currentUserId, 
                        currentWeather.City, 
                        currentWeather.Country);
                    
                    // Auto-add location-based city to favorites and track search count
                    await FavoriteCitiesService.AddOrUpdateFavoriteAsync(
                        currentUserId, 
                        currentWeather.City, 
                        currentWeather.Country);
                    
                    isFavorite = await FavoriteCitiesService.IsFavoriteAsync(
                        currentUserId, 
                        currentWeather.City, 
                        currentWeather.Country);
                    
                    // Reload favorites to update order
                    await LoadFavoriteCitiesAsync();
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            currentWeather = null;
            forecastData = null;
        }
        finally
        {
            isLoadingLocation = false;
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadForecastAsync()
    {
        if (currentWeather == null) return;
        
        try
        {
            forecastData = await WeatherApiService.GetForecastAsync(currentWeather.City, currentWeather.Country);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading forecast: {ex.Message}");
        }
    }

    private async Task LoadForecastByLocationAsync(double lat, double lon)
    {
        try
        {
            forecastData = await WeatherApiService.GetForecastByLocationAsync(lat, lon);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading forecast by location: {ex.Message}");
        }
    }

    private async Task OnCitySelected(ChangeEventArgs args)
    {
        var selected = args.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(selected))
        {
            searchCity = selected;
            await SearchWeather();
        }
    }

    private async Task LoadPopularCitiesAsync()
    {
        try
        {
            var cities = await PopularCitiesApiService.GetPopularCitiesAsync(5);
            if (cities != null && cities.Any())
            {
                popularCities = cities;
            }
            else if (!popularCities.Any())
            {
                popularCities = new List<string>(defaultPopularCities);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading popular cities: {ex.Message}");
            if (!popularCities.Any())
            {
                popularCities = new List<string>(defaultPopularCities);
            }
        }
    }

    private async Task LoadFavoriteCitiesAsync()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        favoriteCitiesLoading = true;
        try
        {
            favoriteCities = await FavoriteCitiesService.GetFavoriteCitiesAsync(currentUserId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading favorite cities: {ex.Message}");
        }
        finally
        {
            favoriteCitiesLoading = false;
        }
    }

    private async Task AddCurrentFavorite()
    {
        if (currentWeather == null || string.IsNullOrEmpty(currentUserId)) return;
        
        var success = await FavoriteCitiesService.AddFavoriteCityAsync(
            currentUserId, 
            currentWeather.City, 
            currentWeather.Country);
        
        if (success)
        {
            isFavorite = true;
            await LoadFavoriteCitiesAsync();
        }
    }

    private async Task RemoveCurrentFavorite()
    {
        if (currentWeather == null || string.IsNullOrEmpty(currentUserId)) return;
        
        var favorite = favoriteCities.FirstOrDefault(f => 
            f.City == currentWeather.City && f.Country == currentWeather.Country);
        
        if (favorite != null)
        {
            var success = await FavoriteCitiesService.RemoveFavoriteCityAsync(currentUserId, favorite.Id);
            if (success)
            {
                isFavorite = false;
                await LoadFavoriteCitiesAsync();
            }
        }
    }

    private async Task LoadFavoriteCity(string city, string country)
    {
        searchCity = city;
        
        // Increment search count for this favorite city
        if (currentUserId != null)
        {
            await FavoriteCitiesService.IncrementSearchCountAsync(currentUserId, city, country);
            await LoadFavoriteCitiesAsync(); // Reload to update order
        }
        
        await SearchWeather();
    }

    private async Task RemoveFavorite(string favoriteId)
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        var success = await FavoriteCitiesService.RemoveFavoriteCityAsync(currentUserId, favoriteId);
        if (success)
        {
            await LoadFavoriteCitiesAsync();
            if (currentWeather != null)
            {
                isFavorite = await FavoriteCitiesService.IsFavoriteAsync(
                    currentUserId, 
                    currentWeather.City, 
                    currentWeather.Country);
            }
        }
    }

    private async Task ToggleTheme()
    {
        await ThemeService.ToggleThemeAsync();
        StateHasChanged();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Code == "Enter")
        {
            await SearchWeather();
        }
    }
}
