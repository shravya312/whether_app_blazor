@using WeatherApp.Client.Models
@using WeatherApp.Client.Services
@inject WeatherAlertsService WeatherAlertsService

@using static WeatherApp.Client.Services.WeatherAlertsService

@if (alerts.Any())
{
    <div class="weather-alerts mb-4">
        <h5 class="mb-3">
            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
            Weather Alerts
        </h5>
        @foreach (var alert in alerts.OrderByDescending(a => a.Severity))
        {
            <div class="alert @GetAlertClass(alert.Severity) alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-start">
                    <i class="bi @GetAlertIcon(alert.Type) me-2"></i>
                    <div>
                        <strong>@alert.Type.ToString()</strong>
                        <p class="mb-0">@alert.Message</p>
                        <small>@alert.City - @alert.Timestamp.ToLocalTime().ToString("g")</small>
                    </div>
                </div>
                <button type="button" class="btn-close" @onclick="() => DismissAlert(alert)"></button>
            </div>
        }
    </div>
}

<style>
    .weather-alerts .alert {
        margin-bottom: 10px;
    }
</style>

@code {
    [Parameter]
    public WeatherData? CurrentWeather { get; set; }

    [Parameter]
    public ForecastData? ForecastData { get; set; }

    private List<WeatherAlert> alerts = new();
    private HashSet<WeatherAlert> dismissedAlerts = new();

    protected override void OnParametersSet()
    {
        if (CurrentWeather != null)
        {
            alerts = WeatherAlertsService.CheckWeatherAlerts(CurrentWeather, ForecastData)
                .Where(a => !dismissedAlerts.Contains(a))
                .ToList();
        }
        else
        {
            alerts.Clear();
        }
    }

    private string GetAlertClass(AlertSeverity severity)
    {
        return severity switch
        {
            AlertSeverity.High => "alert-danger",
            AlertSeverity.Medium => "alert-warning",
            AlertSeverity.Low => "alert-info",
            _ => "alert-secondary"
        };
    }

    private string GetAlertIcon(AlertType type)
    {
        return type switch
        {
            AlertType.SevereHeat => "bi-thermometer-sun",
            AlertType.SevereCold => "bi-thermometer-snow",
            AlertType.HighWind => "bi-wind",
            AlertType.Thunderstorm => "bi-lightning-fill",
            AlertType.HeavyRain => "bi-cloud-rain-heavy",
            AlertType.HeavySnow => "bi-snow",
            AlertType.Fog => "bi-cloud-fog",
            _ => "bi-exclamation-triangle"
        };
    }

    private void DismissAlert(WeatherAlert alert)
    {
        dismissedAlerts.Add(alert);
        alerts.Remove(alert);
        StateHasChanged();
    }
}

