@using WeatherApp.Client.Models
@using WeatherApp.Client.Services
@inject WeatherAlertsService WeatherAlertsService
@inject AlertSettingsService? AlertSettingsService
@inject AlertHistoryService? AlertHistoryService
@inject SupabaseService SupabaseService
@inject EmailNotificationService? EmailNotificationService
@inject IJSRuntime JSRuntime

@using static WeatherApp.Client.Services.WeatherAlertsService

@if (alerts.Any())
{
    <div class="weather-alerts mb-4">
        <h5 class="mb-3">
            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
            Weather Alerts
        </h5>
        @foreach (var alert in alerts.OrderByDescending(a => a.Severity))
        {
            <div class="alert @GetAlertClass(alert.Severity) alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-start">
                    <i class="bi @GetAlertIcon(alert.Type) me-2"></i>
                    <div>
                        <strong>@alert.Type.ToString()</strong>
                        <p class="mb-0">@alert.Message</p>
                        <small>@alert.City, @alert.Country - @alert.Timestamp.ToLocalTime().ToString("g")</small>
                    </div>
                </div>
                <button type="button" class="btn-close" @onclick="() => DismissAlert(alert)"></button>
            </div>
        }
    </div>
}

<style>
    .weather-alerts .alert {
        margin-bottom: 10px;
    }
</style>

@code {
    [Parameter]
    public WeatherData? CurrentWeather { get; set; }

    [Parameter]
    public ForecastData? ForecastData { get; set; }

    private List<WeatherAlert> alerts = new();
    private HashSet<string> dismissedAlertIds = new();
    private HashSet<string> emailsSentForAlerts = new(); // Track alerts that have already triggered emails
    private AlertSettings? alertSettings;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var user = SupabaseService.GetCurrentUser();
        if (user != null && AlertSettingsService != null && !string.IsNullOrEmpty(user.Id))
        {
            currentUserId = user.Id;
            alertSettings = await AlertSettingsService.GetAlertSettingsAsync(currentUserId);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (CurrentWeather != null)
        {
            var newAlerts = await WeatherAlertsService.CheckWeatherAlertsAsync(CurrentWeather, ForecastData, alertSettings);
            
            // Set country for alerts
            foreach (var alert in newAlerts)
            {
                alert.Country = CurrentWeather.Country;
            }
            
            alerts = newAlerts
                .Where(a => !dismissedAlertIds.Contains(a.Id))
                .ToList();

            // Save alerts to history and show notifications
            if (AlertHistoryService != null && currentUserId != null)
            {
                // Get the latest alert (most recent timestamp) for email notification
                var latestAlert = alerts.OrderByDescending(a => a.Timestamp).FirstOrDefault();
                
                // Process all alerts: save to history and show browser notifications
                foreach (var alert in alerts)
                {
                    await AlertHistoryService.SaveAlertAsync(currentUserId, alert);
                    
                    // Show browser notification if enabled (for all alerts)
                    if (alertSettings?.EnablePushNotifications == true)
                    {
                        await ShowNotification(alert);
                    }
                }
                
                // Send email notification ONLY for the latest alert (ONCE per alert cycle)
                if (alertSettings?.EnableEmailNotifications == true && 
                    EmailNotificationService != null && 
                    latestAlert != null &&
                    !emailsSentForAlerts.Contains(latestAlert.Id)) // Only send if not already sent
                {
                    Console.WriteLine($"[WeatherAlerts] ðŸ“§ Email notifications enabled - preparing to send email for LATEST alert only");
                    var user = SupabaseService.GetCurrentUser();
                    if (user?.Email != null)
                    {
                        Console.WriteLine($"[WeatherAlerts] ðŸ“§ User email found: {user.Email}");
                        Console.WriteLine($"[WeatherAlerts] ðŸ“§ Sending email for LATEST alert: {latestAlert.Type} in {latestAlert.City} (Timestamp: {latestAlert.Timestamp})");
                        var emailSent = await EmailNotificationService.SendWeatherAlertEmailAsync(
                            user.Email,
                            latestAlert.City,
                            latestAlert.Country,
                            latestAlert.Message,
                            latestAlert.Type.ToString()
                        );
                        if (emailSent)
                        {
                            // Mark this alert as having sent email
                            emailsSentForAlerts.Add(latestAlert.Id);
                            Console.WriteLine($"[WeatherAlerts] âœ… Email sent successfully to {user.Email} for latest alert (ID: {latestAlert.Id})");
                        }
                        else
                        {
                            Console.WriteLine($"[WeatherAlerts] âŒ Failed to send email to {user.Email}");
                        }
                    }
                    else
                    {
                        Console.WriteLine($"[WeatherAlerts] âš ï¸ User email is null - cannot send email");
                    }
                }
                
                // Log if email notifications are disabled
                if (alertSettings?.EnableEmailNotifications != true && alerts.Any())
                {
                    Console.WriteLine($"[WeatherAlerts] âš ï¸ Email notifications are disabled in settings");
                }
                if (EmailNotificationService == null && alerts.Any())
                {
                    Console.WriteLine($"[WeatherAlerts] âš ï¸ EmailNotificationService is not available");
                }
            }
        }
        else
        {
            alerts.Clear();
        }
    }

    private string GetAlertClass(AlertSeverity severity)
    {
        return severity switch
        {
            AlertSeverity.High => "alert-danger",
            AlertSeverity.Medium => "alert-warning",
            AlertSeverity.Low => "alert-info",
            _ => "alert-secondary"
        };
    }

    private string GetAlertIcon(AlertType type)
    {
        return type switch
        {
            AlertType.SevereHeat => "bi-thermometer-sun",
            AlertType.SevereCold => "bi-thermometer-snow",
            AlertType.HighWind => "bi-wind",
            AlertType.Thunderstorm => "bi-lightning-fill",
            AlertType.HeavyRain => "bi-cloud-rain-heavy",
            AlertType.HeavySnow => "bi-snow",
            AlertType.Fog => "bi-cloud-fog",
            AlertType.HighHumidity => "bi-droplet-fill",
            AlertType.LowHumidity => "bi-droplet",
            _ => "bi-exclamation-triangle"
        };
    }

    private void DismissAlert(WeatherAlert alert)
    {
        dismissedAlertIds.Add(alert.Id);
        alerts.Remove(alert);
        StateHasChanged();
    }

    private async Task ShowNotification(WeatherAlert alert)
    {
        try
        {
            if (await JSRuntime.InvokeAsync<string>("eval", "typeof Notification !== 'undefined' && Notification.permission === 'granted'") == "True")
            {
                await JSRuntime.InvokeVoidAsync("eval", $@"
                    new Notification('{alert.Type} Alert - {alert.City}', {{
                        body: '{alert.Message}',
                        icon: '/favicon.ico',
                        tag: '{alert.Id}',
                        requireInteraction: true
                    }});
                ");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error showing notification: {ex.Message}");
        }
    }
}

