@page "/dashboard"
@attribute [Authorize]
@using WeatherApp.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject WeatherApiService WeatherApiService
@inject FavoriteCitiesService FavoriteCitiesService
@inject SupabaseService SupabaseService
@inject ThemeService ThemeService
@inject FavoriteCitiesMonitorService FavoriteCitiesMonitorService
@inject WeatherAlertsService WeatherAlertsService
@inject AlertSettingsService AlertSettingsService
@inject AlertHistoryService AlertHistoryService
@using static WeatherApp.Client.Services.WeatherAlertsService

<PageTitle>Dashboard - Weather App</PageTitle>

<div class="page-container">
    <div class="d-flex align-items-center justify-content-center mb-4">
        <i class="bi bi-speedometer2 me-3" style="font-size: 2rem; color: var(--accent-primary);"></i>
        <div class="text-center">
            <h2 class="mb-0 fw-bold text-primary-modern">Your Weather Dashboard</h2>
            <p class="text-secondary-modern mb-0">Monitor your favorite cities at a glance</p>
        </div>
    </div>
    
    @if (favoriteCitiesAlerts.Any())
    {
        <div class="modern-card mb-4 mx-auto section-container" style="border-left: 4px solid var(--accent-primary);">
            <div class="d-flex align-items-center justify-content-center mb-3">
                <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem; color: var(--accent-primary);"></i>
                <h5 class="mb-0 fw-bold text-primary-modern">Weather Alerts</h5>
            </div>
            <div class="alert-list">
                @foreach (var alert in favoriteCitiesAlerts.OrderByDescending(a => a.Severity).Take(5))
                {
                    <div class="modern-card mb-2 text-center" style="background: rgba(6, 182, 212, 0.12); border-left: 3px solid var(--accent-primary);">
                        <div class="d-flex flex-column align-items-center">
                            <div class="mb-2">
                                <strong class="text-primary-modern d-block">@alert.City, @alert.Country:</strong>
                                <p class="mb-1 mt-1 text-secondary-modern">@alert.Message</p>
                                <small class="text-muted-modern">
                                    <i class="bi bi-clock"></i> @alert.Timestamp.ToLocalTime().ToString("g")
                                </small>
                            </div>
                            <span class="badge" style="background: var(--accent-primary); color: #ffffff;">@alert.Severity</span>
                        </div>
                    </div>
                }
            </div>
            @if (favoriteCitiesAlerts.Count > 5)
            {
                <div class="text-center mt-3">
                    <a href="/alerts/history" class="btn-modern-outline">
                        <i class="bi bi-arrow-right"></i> View All Alerts
                    </a>
                </div>
            }
        </div>
    }
    
    @if (favoriteCitiesLoading)
    {
        <div class="text-center py-5">
            <div class="loading-spinner mx-auto mb-3"></div>
            <p class="text-secondary-modern">Loading your dashboard...</p>
        </div>
    }
    else if (favoriteCities.Any())
    {
        <div class="widget-grid mx-auto section-container">
            @foreach (var favCity in favoriteCities)
            {
                <div class="weather-widget fade-in">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="mb-1 text-primary-modern fw-bold">@favCity.City</h5>
                            <small class="text-secondary-modern">@favCity.Country</small>
                        </div>
                        <i class="bi bi-geo-alt-fill" style="color: var(--accent-primary); font-size: 1.5rem;"></i>
                    </div>
                    
                    @if (weatherDataCache.ContainsKey(favCity.City))
                    {
                        var weather = weatherDataCache[favCity.City];
                        <div class="current-weather-widget" style="background: transparent; padding: 0; box-shadow: none; border: none;">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div>
                                    <div class="current-temp" style="font-size: 3rem; margin: 0;">@weather.Temperature.ToString("F0")Â°</div>
                                    <div class="current-condition">@weather.Description</div>
                                </div>
                                @if (!string.IsNullOrEmpty(weather.Icon))
                                {
                                    <img src="@($"https://openweathermap.org/img/wn/{weather.Icon}@2x.png")" 
                                         alt="@weather.Description" 
                                         style="width: 80px; height: 80px;" />
                                }
                            </div>
                            
                            <div class="weather-stats-grid">
                                <div class="weather-stat">
                                    <div class="stat-icon">
                                        <i class="bi bi-droplet-fill"></i>
                                    </div>
                                    <div class="stat-value">@weather.Humidity.ToString("F0")%</div>
                                    <div class="stat-label">Humidity</div>
                                </div>
                                <div class="weather-stat">
                                    <div class="stat-icon">
                                        <i class="bi bi-wind"></i>
                                    </div>
                                    <div class="stat-value">@weather.WindSpeed.ToString("F1")</div>
                                    <div class="stat-label">Wind m/s</div>
                                </div>
                                <div class="weather-stat">
                                    <div class="stat-icon">
                                        <i class="bi bi-speedometer2"></i>
                                    </div>
                                    <div class="stat-value">@weather.Pressure.ToString("F0")</div>
                                    <div class="stat-label">hPa</div>
                                </div>
                            </div>
                            
                            <!-- Simulated AQI -->
                            @{
                                var aqi = (int)(50 + (weather.Humidity / 2) + (weather.Pressure / 10));
                                var aqiClass = aqi <= 50 ? "aqi-good" : aqi <= 100 ? "aqi-moderate" : "aqi-unhealthy";
                            }
                            <div class="aqi-widget mt-3" style="background: rgba(255, 255, 255, 0.03); padding: 1rem;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="stat-label">AQI</div>
                                        <div class="stat-value @aqiClass">@aqi</div>
                                    </div>
                                    <div class="text-secondary-modern">
                                        @(aqi <= 50 ? "Good" : aqi <= 100 ? "Moderate" : "Unhealthy")
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-cloud-arrow-down mb-3" style="font-size: 2rem; color: var(--text-secondary);"></i>
                            <p class="text-secondary-modern mb-3">Weather data not loaded</p>
                            <button class="btn-modern btn-sm" @onclick="() => LoadWeatherForCity(favCity.City, favCity.Country)">
                                <i class="bi bi-download"></i> Load Weather
                            </button>
                        </div>
                    }
                    
                    <div class="mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
                        <small class="text-muted-modern">
                            <i class="bi bi-calendar3"></i> Added @favCity.AddedAt.ToLocalTime().ToString("MMM dd, yyyy")
                        </small>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="modern-card text-center py-5 mx-auto section-container">
            <i class="bi bi-inbox mb-3" style="font-size: 3rem; color: var(--text-secondary);"></i>
            <h5 class="fw-bold text-primary-modern">No favorite cities yet!</h5>
            <p class="text-secondary-modern">Start by adding cities to your favorites from the home page to see them here.</p>
            <a href="/" class="btn-modern mt-3">
                <i class="bi bi-house-door"></i> Go to Home
            </a>
        </div>
    }
</div>

@code {
    private List<FavoriteCity> favoriteCities = new();
    private bool favoriteCitiesLoading = true;
    private Dictionary<string, WeatherData> weatherDataCache = new();
    private List<WeatherAlert> favoriteCitiesAlerts = new();
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var user = SupabaseService.GetCurrentUser();
        if (user != null)
        {
            currentUserId = user.Id;
            await LoadFavoriteCitiesAsync();
            await LoadAlertHistory();
        }
    }

    private async Task LoadFavoriteCitiesAsync()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        favoriteCitiesLoading = true;
        try
        {
            favoriteCities = await FavoriteCitiesService.GetFavoriteCitiesAsync(currentUserId);
            
            // Load weather for all favorite cities
            foreach (var city in favoriteCities)
            {
                await LoadWeatherForCity(city.City, city.Country);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            favoriteCitiesLoading = false;
        }
    }

    private async Task LoadWeatherForCity(string city, string country)
    {
        try
        {
            var weather = await WeatherApiService.GetWeatherAsync(city, country);
            if (weather != null)
            {
                weatherDataCache[city] = weather;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading weather for {city}: {ex.Message}");
        }
    }

    private async Task LoadAlertHistory()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        try
        {
            // Load alerts from history (no new checks, no notifications)
            // Only show recent alerts (last 10) on dashboard
            favoriteCitiesAlerts = await AlertHistoryService.GetAlertHistoryAsync(currentUserId, limit: 10);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading alert history: {ex.Message}");
        }
    }
}
