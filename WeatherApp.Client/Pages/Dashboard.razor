@page "/dashboard"
@attribute [Authorize]
@using WeatherApp.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject WeatherApiService WeatherApiService
@inject FavoriteCitiesService FavoriteCitiesService
@inject SupabaseService SupabaseService
@inject ThemeService ThemeService
@inject FavoriteCitiesMonitorService FavoriteCitiesMonitorService
@inject WeatherAlertsService WeatherAlertsService
@inject AlertSettingsService AlertSettingsService
@inject AlertHistoryService AlertHistoryService
@using static WeatherApp.Client.Services.WeatherAlertsService

<PageTitle>Dashboard - Weather App</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center mb-4">
                <i class="bi bi-speedometer2 text-primary me-3" style="font-size: 2rem;"></i>
                <div>
                    <h2 class="mb-0 fw-bold" style="color: #2d3748;">Your Weather Dashboard</h2>
                    <p class="text-muted mb-0">Monitor your favorite cities at a glance</p>
                </div>
            </div>
            
            @if (favoriteCitiesAlerts.Any())
            {
                <div class="alert alert-warning mb-4 border-0 shadow-sm">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0 fw-bold">Weather Alerts for All Cities</h5>
                    </div>
                    <div class="alert-list">
                        @foreach (var alert in favoriteCitiesAlerts.OrderByDescending(a => a.Severity).Take(5))
                        {
                            <div class="alert-item mb-3 p-3 bg-white rounded border-start border-4 border-warning">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong class="text-dark">@alert.City, @alert.Country:</strong>
                                        <p class="mb-1 mt-1">@alert.Message</p>
                                        <small class="text-muted">
                                            <i class="bi bi-clock"></i> @alert.Timestamp.ToLocalTime().ToString("g")
                                        </small>
                                    </div>
                                    <span class="badge bg-warning text-dark">@alert.Severity</span>
                                </div>
                            </div>
                        }
                    </div>
                    @if (favoriteCitiesAlerts.Count > 5)
                    {
                        <div class="text-center mt-3">
                            <a href="/alerts/history" class="btn btn-outline-warning">
                                <i class="bi bi-arrow-right"></i> View All Alerts
                            </a>
                        </div>
                    }
                </div>
            }
            
            @if (favoriteCitiesLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p class="text-muted">Loading your dashboard...</p>
                </div>
            }
            else if (favoriteCities.Any())
            {
                <div class="row">
                    @foreach (var favCity in favoriteCities)
                    {
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title mb-0 fw-bold">@favCity.City, @favCity.Country</h5>
                                        <i class="bi bi-geo-alt-fill text-primary"></i>
                                    </div>
                                    @if (weatherDataCache.ContainsKey(favCity.City))
                                    {
                                        var weather = weatherDataCache[favCity.City];
                                        <div class="weather-widget">
                                            <div class="d-flex align-items-center mb-3">
                                                @if (!string.IsNullOrEmpty(weather.Icon))
                                                {
                                                    <img src="@($"https://openweathermap.org/img/wn/{weather.Icon}@2x.png")" alt="@weather.Description" style="width: 80px; height: 80px;" />
                                                }
                                                <div class="ms-3">
                                                    <div class="h2 mb-0 fw-bold" style="color: #2d3748;">@weather.Temperature.ToString("F1")Â°C</div>
                                                    <small class="text-muted text-capitalize">@weather.Description</small>
                                                </div>
                                            </div>
                                            <div class="weather-stats d-flex gap-3 mt-3 pt-3 border-top">
                                                <div class="text-center flex-fill">
                                                    <i class="bi bi-droplet-fill text-info"></i>
                                                    <div class="small fw-bold">@weather.Humidity%</div>
                                                    <div class="small text-muted">Humidity</div>
                                                </div>
                                                <div class="text-center flex-fill">
                                                    <i class="bi bi-wind text-primary"></i>
                                                    <div class="small fw-bold">@weather.WindSpeed.ToString("F1")</div>
                                                    <div class="small text-muted">Wind m/s</div>
                                                </div>
                                                <div class="text-center flex-fill">
                                                    <i class="bi bi-speedometer2 text-success"></i>
                                                    <div class="small fw-bold">@weather.Pressure</div>
                                                    <div class="small text-muted">hPa</div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="text-center py-4">
                                            <i class="bi bi-cloud-arrow-down text-muted mb-3" style="font-size: 2rem;"></i>
                                            <p class="text-muted mb-3">Weather data not loaded</p>
                                            <button class="btn btn-primary btn-sm" @onclick="() => LoadWeatherForCity(favCity.City, favCity.Country)">
                                                <i class="bi bi-download"></i> Load Weather
                                            </button>
                                        </div>
                                    }
                                </div>
                                <div class="card-footer bg-transparent border-top">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3"></i> Added @favCity.AddedAt.ToLocalTime().ToString("MMM dd, yyyy")
                                    </small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info border-0 shadow-sm">
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-info mb-3" style="font-size: 3rem;"></i>
                        <h5 class="fw-bold">No favorite cities yet!</h5>
                        <p class="text-muted">Start by adding cities to your favorites from the home page to see them here.</p>
                        <a href="/" class="btn btn-primary mt-2">
                            <i class="bi bi-house-door"></i> Go to Home
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<FavoriteCity> favoriteCities = new();
    private bool favoriteCitiesLoading = true;
    private Dictionary<string, WeatherData> weatherDataCache = new();
    private List<WeatherAlert> favoriteCitiesAlerts = new();
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var user = SupabaseService.GetCurrentUser();
        if (user != null)
        {
            currentUserId = user.Id;
            await LoadFavoriteCitiesAsync();
            await LoadAlertHistory();
        }
    }

    private async Task LoadFavoriteCitiesAsync()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        favoriteCitiesLoading = true;
        try
        {
            favoriteCities = await FavoriteCitiesService.GetFavoriteCitiesAsync(currentUserId);
            
            // Load weather for all favorite cities
            foreach (var city in favoriteCities)
            {
                await LoadWeatherForCity(city.City, city.Country);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            favoriteCitiesLoading = false;
        }
    }

    private async Task LoadWeatherForCity(string city, string country)
    {
        try
        {
            var weather = await WeatherApiService.GetWeatherAsync(city, country);
            if (weather != null)
            {
                weatherDataCache[city] = weather;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading weather for {city}: {ex.Message}");
        }
    }

    private async Task LoadAlertHistory()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        try
        {
            // Load alerts from history (no new checks, no notifications)
            // Only show recent alerts (last 10) on dashboard
            favoriteCitiesAlerts = await AlertHistoryService.GetAlertHistoryAsync(currentUserId, limit: 10);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading alert history: {ex.Message}");
        }
    }
}


